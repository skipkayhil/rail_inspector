#!/usr/bin/env ruby

$:.unshift(File.expand_path("../lib", __dir__))
require "changelog"
require "pathname"

RAILS_PATH = Pathname.new(ARGV.first)
CHANGELOG_PATHS = Dir[RAILS_PATH.join("*/CHANGELOG.md")]

changelogs = CHANGELOG_PATHS.map { |path| File.read(path) }.map(&Changelog::Parser)

errors =
  changelogs.flat_map do |entries|
    invalid_entries = entries.reject(&:valid?)

    output = invalid_entries.empty? ? "." : "F"
    $stdout.write(output)

    invalid_entries
  end

$stdout.write("\n\n")

unless errors.empty?
  puts "Offenses:\n\n"

  errors.each do |e|
    puts e.path
    puts e
  end
end

puts "#{changelogs.length} changelogs inspected, #{errors.length} offense#{"s" unless errors.length == 1} detected"
exit errors.empty?
